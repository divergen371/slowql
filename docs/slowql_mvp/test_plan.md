# テスト計画書: SlowQL MVP

## 1. テスト戦略

品質を担保するため、以下の 2 層のテストを実施します。

### 1.1 単体テスト (Unit Testing)

コアロジックの正確性を検証します。OCaml の標準的なテストフレームワークである `alcotest` の導入を推奨します。

- **対象モジュール**:
  - `Fingerprint`: SQL 正規化ロジックの入力と期待される出力を検証。
  - `Stats`: 数値リストに対する統計計算（平均、パーセンタイル等）の正確性を検証。
  - `Parser`: 特定のログ行文字列に対し、正しいレコード構造体が返されるか検証。

### 1.2 統合テスト (Integration Testing)

CLI ツールとしてビルドし、実際のファイルを入出力として動作を検証します。

- **検証内容**:
  - 引数パース（`--db`, `--top` 等）の挙動。
  - ファイル読み込み（プレーンテキストおよび Gzip）。
  - JSON/CSV 出力ファイルのフォーマットと内容の妥当性。

## 2. テスト項目詳細

### 2.1 Fingerprint (正規化)

| ID   | テストケース   | 入力例                                 | 期待される出力                   |
| ---- | -------------- | -------------------------------------- | -------------------------------- |
| F-01 | 数値の置換     | `SELECT * FROM t WHERE id = 123`       | `select * from t where id = ?`   |
| F-02 | 文字列の置換   | `SELECT * FROM t WHERE name = 'alice'` | `select * from t where name = ?` |
| F-03 | 複数空白の短縮 | `SELECT  *   FROM    t`                | `select * from t`                |
| F-04 | IN 句の短縮    | `IN (1, 2, 3)`                         | `in ( ... )` (※実装依存)         |

### 2.2 Parser (ログ解析)

| ID   | 対象  | テストケース   | 期待値                                          |
| ---- | ----- | -------------- | ----------------------------------------------- |
| P-01 | PG    | 標準的なログ行 | duration, statement が抽出できること            |
| P-02 | PG    | 複数行クエリ   | 改行を含むクエリが 1 つの文として抽出されること |
| P-03 | MySQL | 標準ヘッダー   | Query_time, Lock_time 等が抽出できること        |
| P-04 | MySQL | `#` コメント行 | 無視される、または適切に処理されること          |

### 2.3 Stats (統計)

| ID   | テストケース   | 内容                                                   |
| ---- | -------------- | ------------------------------------------------------ |
| S-01 | 基本統計       | Count, Sum, Avg, Max が正しく計算されること            |
| S-02 | パーセンタイル | P50, P95, P99 が（近似値または正確値で）計算されること |
| S-03 | 空データ       | データなしの場合にクラッシュせず、0 または空を返すこと |

### 2.4 CLI & System

| ID   | テストケース  | 内容                                                                           |
| ---- | ------------- | ------------------------------------------------------------------------------ |
| C-01 | Gzip 読み込み | `.gz` 拡張子のファイルを解凍して読み込めること                                 |
| C-02 | 自動判別      | `--db auto` で拡張子や内容から DB タイプを推測できること（今回は拡張子依存か） |
| C-03 | 出力生成      | 指定パスに JSON/CSV が生成され、Valid なフォーマットであること                 |

## 3. テストデータ準備

テスト実行のために以下のダミーデータを用意します。

1.  **`test/data/pg_dummy.log`**
    - PostgreSQL 形式。単純なクエリ、パラメータ付きクエリ、複数行クエリを含む。
2.  **`test/data/mysql_dummy.log`**
    - MySQL 形式。典型的なスロークエリログ。
3.  **`test/data/large.log.gz`**
    - Gzip 圧縮読み込みテスト用。

## 4. 実行環境とツール

- **テストランナー**: `dune runtest`
- **ライブラリ**: `alcotest` (opam ファイルへの追加が必要)
