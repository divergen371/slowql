# 追加機能の検討案

MVP（Minimum Viable Product）の次のステップ、あるいは余裕があれば今回のスコープに含めることができる追加機能の案です。

## 1. 分析・フィルタリング機能の強化

- **期間フィルタリング (`--since`, `--until`)**
  - ログ全体ではなく、特定の時間帯（例: 障害発生時刻前後）のみを解析対象とする機能。
- **ユーザー/ホスト別集計**
  - クエリ単位だけでなく、どのユーザーやクライアント IP からの負荷が高いかを集計するモード。
- **閾値フィルタ (`--min-time`)**
  - 解析対象とする最小実行時間を CLI で上書き設定する機能（ログ自体の設定とは別に）。

## 2. 出力・レポートの強化

- **HTML レポート出力**
  - `pt-query-digest` のように、グラフやヒストグラムを含むリッチな HTML レポートを生成。
  - 実行時間の分布を視覚的に確認できるようにする。
- **Markdown レポート出力**
  - GitHub の Issue や Pull Request にそのまま貼り付けられる形式での出力。
- **Diff モード**
  - 2 つのログファイル（例: インデックス追加前と追加後）を比較し、性能改善・悪化をレポートする機能。

## 3. 利便性・安全性

- **機密情報のマスキング（Anonymization）**
  - ログを外部（開発ベンダーなど）に共有する際、テーブル名やカラム名をハッシュ化したり、リテラルを完全に隠蔽したりする機能。
- **インタラクティブモード (TUI)**
  - ターミナル上で `top` コマンドのように、ソート順を切り替えたり詳細をドリルダウンしたりできる UI。

## 4. 統計指標の強化

- **標準偏差（STD）**
  - クエリ実行時間のばらつきを把握するため、標準偏差を計算・表示する機能。
  - パーセンタイルと合わせて、性能の安定性を評価できる。
- **P1 パーセンタイル**
  - 最速 1%のクエリを把握し、最適な場合の性能を確認する。
- **中央値（Median）の明示的表示**
  - P50 と同義だが、統計用語として「中央値」を明示的に表示するオプション。
- **変動係数（CV: Coefficient of Variation）**
  - CV = std / avg として計算し、異なる平均を持つクエリのばらつきを比較可能にする。
  - CV が大きいクエリは不安定（キャッシュヒット率やデータ量で性能が大きく変わる）。
- **四分位範囲（IQR: Interquartile Range）**
  - IQR = P75 - P25 として計算し、外れ値に影響されにくい散布度を示す。
  - 中央 50%のデータの範囲を把握。
- **外れ値の検出と割合**
  - P99 以上、または Box Plot 方式（P25 - 1.5*IQR 未満 or P75 + 1.5*IQR 超）で外れ値を検出。
  - 「100 回中 5 回は極端に遅い」といった情報を提供し、調査の優先度付けに活用。
- **P90-P10 範囲**
  - Range90 = P90 - P10 として、上位 10%と下位 10%を除いた中央 80%の範囲を表示。
  - SLO 設定（「80%のクエリは〇〇秒以内」）に有用。
- **中央絶対偏差（MAD: Median Absolute Deviation）**
  - MAD = median(|xi - median(x)|) として計算し、外れ値に頑健な散布度指標を提供。
  - 極端に遅いクエリがある場合でも、典型的なばらつきを正確に把握。
- **時間帯別集計**
  - 1 時間ごと/曜日ごとのクエリ数・平均実行時間を集計。
  - ピーク時間帯の特定、日次・週次でのトレンド分析、性能劣化の早期検出。
- **累積分布関数（CDF）**
  - 「X%のクエリが Y 秒以内」を連続的に可視化。
  - P50/P95/P99 だけでなく、分布の全体像を把握。
- **実行時間のヒストグラム**
  - 0-100ms, 100-500ms, 500ms-1s, 1-5s, 5s-10s, 10s+ などでビン分け。
  - 分布の形状（単峰性、二峰性など）を視覚的に理解。

## 5. HTML レポートの機能拡張（aqueue スタイル）

- **表形式の統計サマリー**
  - COUNT, MIN, MAX, SUM, AVG, P1, P50, P99, STD を含む見やすいテーブル表示。
  - ソート可能なカラム（JavaScript）で、任意の指標でソートできる。
- **グラフ・ヒストグラム**
  - 実行時間の分布を視覚化するヒストグラム。
  - 時系列グラフ（時間帯ごとの負荷推移）。
- **インタラクティブなフィルタリング**
  - ブラウザ上で特定のクエリパターンやユーザーでフィルタリングできる UI。

## 6. コンテキスト情報の記録

- **発行元情報の記録**
  - PostgreSQL/MySQL ログに含まれるユーザー名、データベース名、ホスト情報を抽出・集計。
  - 「どのユーザー/データベースから負荷が高いか」を特定しやすくする。
- **クエリ ID やセッション情報**
  - ログに含まれるセッション ID やトランザクション ID を記録し、関連クエリをグルーピング。

## 7. リアルタイムプロファイリング（将来構想）

- **アプリケーション組み込み型トレーサー**
  - `aquery`のように、アプリケーションコードに組み込んで実行時にクエリをトレースする機能。
  - OCaml アプリケーション用のトレーサーライブラリを提供。
  - HTTP エンドポイント経由でリアルタイムプロファイルを取得（例: `/debug/slowql`）。
- **コールスタック情報**
  - どのコード行からクエリが発行されたかを記録（スタックトレース）。
  - デバッグやチューニングの効率が向上。

## 8. 高度な機能

- **`EXPLAIN` 自動実行**
  - DB 接続情報を渡し、抽出されたスロークエリに対して自動的に `EXPLAIN` を実行して実行計画を取得・添付する機能。
- **インデックス推奨**
  - `EXPLAIN` 結果を解析し、フルテーブルスキャンを検出して「この列にインデックスを追加すると改善する可能性があります」と提案。
- **クエリ書き換え提案**
  - 非効率なパターン（`SELECT *`、`OR` の連続、`LIKE '%...'` など）を検出し、改善案を提示。
- **N+1 問題の検出**
  - 同じパターンのクエリが短時間に多数実行されている場合に警告し、バッチ化を推奨。

## 9. 通知・外部連携

- **Slack/Discord 通知**
  - しきい値を超えたクエリをリアルタイムで通知する Webhook 連携。
- **Prometheus/Grafana エクスポート**
  - メトリクスを時系列データとして出力し、既存の監視基盤に統合。
- **GitHub Actions/CI 連携**
  - PR のパフォーマンステスト結果を自動コメント、リグレッション検出。
- **カスタム Webhook**
  - 任意の HTTP エンドポイントに結果を POST。

## 10. 自動化・運用支援

- **定期実行（cron 統合）**
  - 毎日/毎週の自動レポート生成とメール送信。
- **アラート設定**
  - P95 が閾値を超えたら警告メール/通知を送信。
- **差分検出（リグレッション検出）**
  - 前回実行時と比較して悪化したクエリをハイライト表示。
- **ロールバック推奨**
  - デプロイ後に性能が大幅に悪化した場合に自動警告。
- **環境間比較**
  - dev/staging/prod のログを並べて比較し、環境差異を可視化。

## 11. 開発者体験向上

- **SQL フォーマッター統合**
  - 出力するクエリを自動整形（`pg_format` や `sql-formatter` 連携）。
- **デバッグモード**
  - より詳細なログ出力、中間データの保存、パース失敗時の詳細エラー。
- **VSCode 拡張**
  - エディタ内でレポートを表示し、問題のあるクエリにジャンプ。
- **対話的クエリビルダー**
  - CLI で「どのテーブルを解析しますか？」など、段階的に条件を設定。

## 12. データエクスポート・統合

- **データベース直接書き込み**
  - PostgreSQL/MySQL に結果テーブルを作成し、SQL で再分析可能に。
- **Elasticsearch 連携**
  - Kibana での可視化に対応。
- **Parquet/Avro 出力**
  - データレイク連携、BigQuery へのインポート。
- **クラウドストレージ自動アップロード**
  - S3/GCS に結果を自動保存（AWS SDK/GCS SDK 連携）。

## 13. セキュリティ・コンプライアンス

- **機密データスキャン**
  - クエリ内のクレジットカード番号、メールアドレス、電話番号などを検出して警告。
- **監査ログ生成**
  - 誰がいつどのクエリを実行したかの記録を JSON で出力。
- **アクセスパターン分析**
  - 異常なアクセスパターン（深夜の大量クエリなど）を検出。
- **GDPR 対応支援**
  - 個人情報を含む可能性のあるクエリを追跡・マーク。

## 14. 可視化・レポーティング拡張

- **リアルタイム Web ダッシュボード**
  - `cohttp-lwt-unix` を使用した軽量 Web サーバーでライブダッシュボード提供。
- **PDF 出力**
  - 経営陣向けレポート、月次報告書の自動生成。
- **グラフ自動生成**
  - 実行時間推移グラフ、分布グラフを PNG/SVG で出力（`vg` ライブラリ使用）。
- **カスタムテンプレート**
  - 組織に合わせたレポートフォーマットを Mustache/Jingoo で定義。

## 15. 拡張性・プラグインシステム

- **プラグインアーキテクチャ**
  - カスタムパーサーや出力形式を動的ロード可能に（`.cmxs` ファイル）。
- **スクリプト連携**
  - Python/Ruby スクリプトでポストプロセッシング（JSON を stdin で受け取り）。
- **REST API 提供**
  - HTTP エンドポイントで解析結果を取得、外部ツールから利用。
- **ストリーミング処理**
  - 大容量ログをメモリに載せずに順次処理（`Lwt_io` 使用）。
